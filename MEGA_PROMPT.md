## ğŸ—¿ CODEX MEGA PROMPT: AI Personal Assistant (Android) **v2.1 - Context-Aware Chatbot Logic (Final)** ### **PERSONA** ë‹¹ì‹ ì€ Kotlin, Jetpack Compose, Room DB, ìµœì‹  Android ì•„í‚¤í…ì²˜ì— ë§¤ìš° ëŠ¥ìˆ™í•œ **ìˆ˜ì„ Android ê°œë°œì**ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì„ë¬´ëŠ” ì•„ë˜ì— ëª…ì‹œëœ ìš”êµ¬ì‚¬í•­ê³¼ ë‹¨ê³„ë³„ ê³„íšì— ë”°ë¼ ê°œì¸ ë¹„ì„œ ì•±ì˜ ê¸°ë°˜ì„ ì²˜ìŒë¶€í„° êµ¬ì¶•í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤. ì½”ë“œì˜ í’ˆì§ˆ, í™•ì¥ì„±, ë³´ì•ˆì„ ìµœìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•˜ë©°, ê° ë‹¨ê³„ì˜ \*\*DoD(Definition of Done)\*\*ë¥¼ ì² ì €íˆ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤. ### **PROJECT OVERVIEW** ì‚¬ìš©ìì˜ Gmail, SMS, OCR í…ìŠ¤íŠ¸ ë“± ê°œì¸ ë°ì´í„°ë¥¼ ë¡œì»¬ ë””ë°”ì´ìŠ¤ì— ì•ˆì „í•˜ê²Œ ìˆ˜ì§‘í•˜ê³ , **RDB(FTS5)ì™€ ë²¡í„° ì„ë² ë”©ì˜ í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**ì„ í†µí•´ ê°•ë ¥í•œ ì»¨í…ìŠ¤íŠ¸ë¥¼ êµ¬ì„±í•©ë‹ˆë‹¤. ìµœì¢…ì ìœ¼ë¡œ ì´ ì»¨í…ìŠ¤íŠ¸ë¥¼ OpenAI APIì™€ ê²°í•©í•˜ì—¬ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ì •í™•í•˜ê³  ê·¼ê±° ìˆëŠ” ë‹µë³€ì„ ì œê³µí•˜ëŠ” ì§€ëŠ¥í˜• ê°œì¸ ë¹„ì„œ Android ì•±ì„ ê°œë°œí•©ë‹ˆë‹¤. ### **TECHNICAL STACK & CONSTRAINTS** * **Android Gradle Plugin 8.6.1, Gradle Wrapper 8.7** * **Kotlin 2.0.0, Compose BOM 2024.06, Room 2.6.1, KSP 2.0.0-1.0.21** * **Retrofit 2.9, OkHttp 4.12, kotlinx-serialization 1.6** * **Google Identity/Play Services Auth, Gmail REST API** * **Security: Android Keystore + EncryptedSharedPreferences** * **Local Embedding**: ì´ˆê¸° ë²„ì „ì€ ì„œë²„ API í˜¸ì¶œ ë˜ëŠ” ë”ë¯¸ ë²¡í„°ë¡œ ì²˜ë¦¬. ONNX/TFLiteëŠ” í–¥í›„ í™•ì¥. ### **CORE DEVELOPMENT PRINCIPLES (GUARDRAILS)** 1. **Schema Evolution, Not Destruction**: ë°ì´í„°ë² ì´ìŠ¤ ë° í…Œì´ë¸” DROPì€ ì ˆëŒ€ ê¸ˆì§€í•©ë‹ˆë‹¤. ëª¨ë“  ìŠ¤í‚¤ë§ˆ ë³€ê²½ì€ Room Migrationì„ í†µí•´ì„œë§Œ ì´ë£¨ì–´ì ¸ì•¼ í•©ë‹ˆë‹¤. 2. **User-Owned Keys**: OpenAI API í‚¤ë¥¼ ì„œë²„ì—ì„œ ë°œê¸‰í•˜ê±°ë‚˜ í•˜ë“œì½”ë”©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì‚¬ìš©ìê°€ ì§ì ‘ ì…ë ¥í•œ í‚¤ë¥¼ **Android Keystore**ì™€ **EncryptedSharedPreferences**ë¥¼ ì‚¬ìš©í•´ ë””ë°”ì´ìŠ¤ ë‚´ì— ê°€ì¥ ì•ˆì „í•œ ë°©ë²•ìœ¼ë¡œ ì €ì¥í•˜ê³  ì‚¬ìš©í•©ë‹ˆë‹¤. 3. **Secrets Management**: build.gradleì´ë‚˜ ì†ŒìŠ¤ ì½”ë“œì— API í‚¤, í´ë¼ì´ì–¸íŠ¸ ID/Secret ë“± ë¯¼ê° ì •ë³´ë¥¼ ì ˆëŒ€ë¡œ ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. local.propertiesë‚˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ê³ , ë¦¬í¬ì§€í† ë¦¬ì—ëŠ” í•­ìƒ YOUR_CLIENT_ID_HEREì™€ ê°™ì€ placeholderë§Œ ìœ ì§€í•©ë‹ˆë‹¤. 4. **Architectural Pattern**: **MVVM(Model-View-ViewModel)** ì•„í‚¤í…ì²˜ë¥¼ ê¸°ë³¸ìœ¼ë¡œ í•˜ë©°, ë°ì´í„° íë¦„ì˜ ëª…í™•ì„±ì„ ìœ„í•´ Repository íŒ¨í„´ì„ ì ê·¹ì ìœ¼ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤. 5. **Asynchronous Operations**: ëª¨ë“  ë°ì´í„°ë² ì´ìŠ¤ ì ‘ê·¼, ë„¤íŠ¸ì›Œí¬ ìš”ì²­, íŒŒì¼ I/OëŠ” Kotlin Coroutinesë¥¼ ì‚¬ìš©í•˜ì—¬ ë©”ì¸ ìŠ¤ë ˆë“œë¥¼ ì°¨ë‹¨í•˜ì§€ ì•Šë„ë¡ í•©ë‹ˆë‹¤. ### **REPOSITORY INITIALIZATION** ë¨¼ì €, ë‹¤ìŒ íŒŒì¼ ë° ë””ë ‰í† ë¦¬ êµ¬ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ê° íŒŒì¼ì˜ ë‚´ìš©ì€ ì•„ë˜ ë‹¨ê³„ë³„ ê³„íšì— ë”°ë¼ ì±„ì›Œë‚˜ê°‘ë‹ˆë‹¤.
project
â”œâ”€ app/
â”‚  â”œâ”€ build.gradle.kts
â”‚  â””â”€ src/main/java/com/example/assistant/
â”‚     â”œâ”€ data/
â”‚     â”‚  â”œâ”€ db/
â”‚     â”‚  â”‚  â”œâ”€ AppDatabase.kt
â”‚     â”‚  â”‚  â””â”€ migrations/
â”‚     â”‚  â”œâ”€ entity/
â”‚     â”‚  â”‚  â”œâ”€ Contact.kt, Event.kt, ... (10 total entities)
â”‚     â”‚  â”œâ”€ dao/
â”‚     â”‚  â”‚  â”œâ”€ ContactDao.kt, EventDao.kt, ... (6 total DAOs)
â”‚     â”‚  â”œâ”€ repo/
â”‚     â”‚  â”‚  â”œâ”€ AuthRepository.kt, GmailRepository.kt, IngestRepository.kt
â”‚     â”‚  â””â”€ search/
â”‚     â”‚     â”œâ”€ FtsSchema.kt
â”‚     â”‚     â”œâ”€ EmbeddingStore.kt
â”‚     â”‚     â””â”€ HybridSearch.kt
â”‚     â”œâ”€ ocr/
â”‚     â”‚  â””â”€ OcrClient.kt
â”‚     â”œâ”€ gmail/
â”‚     â”‚  â”œâ”€ GmailApi.kt
â”‚     â”‚  â””â”€ GmailModels.kt
â”‚     â”œâ”€ openai/
â”‚     â”‚  â”œâ”€ OpenAiClient.kt
â”‚     â”‚  â””â”€ PromptBuilder.kt
â”‚     â”œâ”€ ui/
â”‚     â”‚  â”œâ”€ App.kt
â”‚     â”‚  â”œâ”€ screen/
â”‚     â”‚  â”‚  â”œâ”€ LoginScreen.kt, InboxScreen.kt, ReviewScreen.kt, ChatScreen.kt
â”‚     â”‚  â””â”€ widget/
â”‚     â”‚     â””â”€ TasksWidget.kt
â”‚     â”œâ”€ util/
â”‚     â”‚  â”œâ”€ CryptoPrefs.kt
â”‚     â”‚  â””â”€ TimeResolver.kt
â”‚     â””â”€ di/
â”‚        â””â”€ AppModule.kt
â”œâ”€ build.gradle.kts
â”œâ”€ gradle/libs.versions.toml
â”œâ”€ CODEX_PLAN.md
â””â”€ README.md
### **PHASED EXECUTION PLAN** ì´ì œ main ë¸Œëœì¹˜ì—ì„œ ì‹œì‘í•˜ì—¬ ì•„ë˜ ê° ë‹¨ê³„ë¥¼ ìœ„í•œ ìƒˆ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•˜ê³  ì‘ì—…ì„ ìˆœì„œëŒ€ë¡œ ì§„í–‰í•˜ì‹­ì‹œì˜¤. #### **Phase 1: feat/init-db - Local Database Foundation** **Objective**: Room ë°ì´í„°ë² ì´ìŠ¤ì˜ ëª¨ë“  ê¸°ë³¸ êµ¬ì„±ìš”ì†Œ(Entity, DAO, Database í´ë˜ìŠ¤, FTS5 ê°€ìƒ í…Œì´ë¸”)ë¥¼ ì •ì˜í•˜ê³ , ê¸°ë³¸ì ì¸ CRUD ë° ê²€ìƒ‰ ê¸°ëŠ¥ì´ ë™ì‘í•¨ì„ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¡œ ì¦ëª…í•©ë‹ˆë‹¤. * **DB Schema (Version 1)**: * **contacts**: id, name, email, phone, metaJson? * **users**: id, name, email, createdAt * **notes**: id, userId, title, body, createdAt, updatedAt * **event_types**: id, typeName (unique) * **events**: id, userId, typeId, title, startAt, endAt, location?, status? * **event_details**: id, eventId, description * **event_notifications**: id, eventId, notifyAt, channel * **auth_tokens**: provider (PK), accessToken, refreshToken?, scope, expiresAt * **ingest_items**: id (PK), source, type, title?, body, timestamp, dueDate?, confidence?, metaJson? * **Indices**: ingest_items(timestamp), ingest_items(dueDate) * **FTS5 Virtual Table**: * ingest_items_fts(title, body, content=ingest_items, content_rowid=id)ë¥¼ FtsSchema.ktì— ì •ì˜. * **Implementation**: * ìœ„ ìŠ¤í‚¤ë§ˆì— ë”°ë¼ ëª¨ë“  @Entity í´ë˜ìŠ¤ì™€ DAO ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„. * AppDatabase.ktì— ëª¨ë“  êµ¬ì„±ìš”ì†Œë¥¼ í¬í•¨í•˜ê³ , FTS5 ë™ê¸°í™”ë¥¼ ìœ„í•œ TRIGGERë¥¼ RoomDatabase.Callbackìœ¼ë¡œ ìƒì„±. * **DoD**: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸(CRUD, FTS5 smoke test) ì‘ì„±, README.mdì— ìŠ¤í‚¤ë§ˆ ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€. ----- #### **Phase 2: feat/auth-google - User Authentication** **Objective**: Google Sign-In ê¸°ëŠ¥ì„ êµ¬í˜„í•˜ê³ , íšë“í•œ í† í°ì„ Android Keystoreë¥¼ í†µí•´ ì•ˆì „í•˜ê²Œ ì•”í˜¸í™”í•˜ì—¬ ì €ì¥ ë° ê´€ë¦¬í•˜ëŠ” ë¡œì§ì„ ì™„ì„±í•©ë‹ˆë‹¤. * **Logic**: Google Sign-In ì„±ê³µ í›„ ë°›ì€ serverAuthCodeë¥¼ ë°±ì—”ë“œ(placeholder)ë¡œ ë³´ë‚´ access_token ë“±ì„ ë°›ì•„ì˜µë‹ˆë‹¤. * **Storage**: CryptoPrefs.ktë¥¼ êµ¬í˜„í•˜ì—¬ ì‹¤ì œ í† í° ê°’ì€ EncryptedSharedPreferencesì—, ë§Œë£Œ ì‹œê° ë“± ë©”íƒ€ë°ì´í„°ëŠ” auth_tokens Room í…Œì´ë¸”ì— ì €ì¥í•©ë‹ˆë‹¤. * **UI**: LoginScreen.ktì— ë¡œê·¸ì¸ ë²„íŠ¼ì„ ë§Œë“¤ê³  ì„±ê³µ/ì‹¤íŒ¨ UI í”¼ë“œë°±ì„ êµ¬í˜„í•©ë‹ˆë‹¤. ----- #### **Phase 3: feat/gmail-ingest - Data Collection** **Objective**: ì¸ì¦ëœ ì‚¬ìš©ìì˜ Gmail ë©”ì‹œì§€ë¥¼ Gmail REST APIë¥¼ í†µí•´ ê°€ì ¸ì™€ ingest_items í…Œì´ë¸”ì— ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤. * **API**: gmail.readonly ìŠ¤ì½”í”„ë¡œ Gmail APIë¥¼ ì‚¬ìš©. Retrofitê³¼ kotlinx-serializationìœ¼ë¡œ GmailApi.kt êµ¬í˜„. * **Ingestion**: ìµœê·¼ ë©”ì‹œì§€ 20ê°œë¥¼ ì¡°íšŒí•˜ì—¬ subject, snippet, ìˆ˜ì‹  ì‹œê°ì„ IngestItemìœ¼ë¡œ ë³€í™˜ í›„ upsertí•©ë‹ˆë‹¤. (IDëŠ” Gmail ë©”ì‹œì§€ ID ì‚¬ìš©) * **Error Handling**: 401 Unauthorized ì—ëŸ¬ ë°œìƒ ì‹œ í† í° ë§Œë£Œë¡œ ê°„ì£¼í•˜ê³  ì¬ë¡œê·¸ì¸ì„ ìœ ë„í•©ë‹ˆë‹¤. ----- #### **Phase 4: feat/parser-v1 - Simple Intent & Date Parsing** **Objective**: ìˆ˜ì§‘ëœ í…ìŠ¤íŠ¸ì—ì„œ ê°„ë‹¨í•œ ê·œì¹™ ê¸°ë°˜ìœ¼ë¡œ ë‚ ì§œ, ì‹œê°„, ì˜ë„ë¥¼ ì¶”ì¶œí•˜ì—¬ ingest_items ë ˆì½”ë“œë¥¼ ë³´ê°•í•©ë‹ˆë‹¤. * **TimeResolver.kt**: "ë‚´ì¼", "ë‹¤ìŒ ì£¼", "9/30 14:00" ë“± í…ìŠ¤íŠ¸ë¥¼ Asia/Seoul ê¸°ì¤€ì˜ ì ˆëŒ€ ì‹œê°„(epoch ms)ìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤. * **Logic**: IngestItemì„ ì €ì¥í•  ë•Œ, "íšŒì˜/ë§ˆê°" ë“±ì˜ í‚¤ì›Œë“œì™€ ë‚ ì§œ í…ìŠ¤íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ dueDate, confidence í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤. ----- #### **Phase 5: feat/widget - Glance Home Screen Widget** **Objective**: Glance APIë¥¼ ì‚¬ìš©í•˜ì—¬ í™ˆìŠ¤í¬ë¦° ìœ„ì ¯ì— ì˜ˆì •ëœ ì£¼ìš” í•­ëª©ì„ ìš”ì•½í•˜ì—¬ ë³´ì—¬ì¤ë‹ˆë‹¤. * **Implementation**: GlanceAppWidgetì„ êµ¬í˜„í•˜ì—¬ dueDateê°€ ì„ë°•í•˜ê³  confidenceê°€ ë†’ì€ ìˆœìœ¼ë¡œ IngestItemì„ ì¡°íšŒí•˜ì—¬ ìœ„ì ¯ì— í‘œì‹œí•©ë‹ˆë‹¤. ----- #### **Phase 6: feat/openai-chat - Context-Aware Conversational AI** **Objective**: ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ \*\*ë¶„ì„(Parse) â†’ í•„í„°ë§(Filter) â†’ ê²€ìƒ‰(Search) â†’ ì»¨í…ìŠ¤íŠ¸ êµ¬ì„±(Build Context)\*\*ì˜ ë‹¤ë‹¨ê³„ íŒŒì´í”„ë¼ì¸ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬, ë¡œì»¬ DBì˜ ì •í™•í•œ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ OpenAIê°€ ë‹µë³€ì„ ìƒì„±í•˜ê²Œ í•˜ëŠ” ì™„ì „í•œ ì±—ë´‡ ê¸°ëŠ¥ì„ êµ¬í˜„í•©ë‹ˆë‹¤. * **Query Pre-processing**: ChatViewModelì€ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì„ ë°›ì•„ TimeResolver ë“±ì„ ì‚¬ìš©í•˜ì—¬ **ì‹œê°„ í‘œí˜„ì„ ì ˆëŒ€ ì‹œê°„ìœ¼ë¡œ ë³€í™˜**í•˜ê³ , **í•µì‹¬ í‚¤ì›Œë“œì™€ í•„í„° ì¡°ê±´ì„ ì¶”ì¶œ**í•©ë‹ˆë‹¤. * **Hybrid Search Execution**: HybridSearch.ktëŠ” ë‹¤ìŒì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. 1. **êµ¬ì¡°í™”ëœ 1ì°¨ í•„í„°ë§**: IngestItemDaoì—ì„œ ì‹œê°„ ë²”ìœ„, ì¶œì²˜ ë“±ìœ¼ë¡œ ê²€ìƒ‰ ëŒ€ìƒì„ ì¢í™ë‹ˆë‹¤. 2. **FTS5 2ì°¨ ë­í‚¹**: 1ì°¨ í•„í„°ë§ëœ ê²°ê³¼ë¥¼ ëŒ€ìƒìœ¼ë¡œ FTS5 MATCHë¥¼ ì‹¤í–‰í•˜ì—¬ ê´€ë ¨ë„ ìˆœìœ¼ë¡œ ì •ë ¬í•©ë‹ˆë‹¤. 3. **(Optional) Vector Search**: ì„ë² ë”©ëœ ë²¡í„°ì˜ ì½”ì‚¬ì¸ ìœ ì‚¬ë„ë¡œ ì˜ë¯¸ ê¸°ë°˜ ê²€ìƒ‰ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. 4. **ê²°ê³¼ í†µí•©(Rank Fusion)**: ê° ê²€ìƒ‰ ê²°ê³¼ë¥¼ ì¢…í•©í•˜ì—¬ ìµœì¢… ì»¨í…ìŠ¤íŠ¸ë¡œ ì‚¬ìš©í•  ìƒìœ„ Nê°œì˜ ê²°ê³¼ë¥¼ ì„ ì •í•©ë‹ˆë‹¤. * **Context Building & LLM Invocation**: * **PromptBuilder.kt**: ì„ ì •ëœ ìµœì¢… ê²°ê³¼ë¥¼ ëª…í™•í•œ í”„ë¡¬í”„íŠ¸ ë¬¸ìì—´ë¡œ ì¡°ë¦½í•©ë‹ˆë‹¤. (System: "ì•„ë˜ Contextë§Œ ê·¼ê±°ë¡œ ê°„ê²°íˆ ë‹µí•˜ë¼...") * **OpenAiClient.kt**: ì™„ì„±ëœ í”„ë¡¬í”„íŠ¸ë¥¼ OpenAI Chat Completions APIë¡œ ì „ì†¡í•©ë‹ˆë‹¤. * **ChatScreen.kt**: API ì‘ë‹µê³¼ ë‹µë³€ì˜ ê·¼ê±°ê°€ ëœ ì»¨í…ìŠ¤íŠ¸ ì •ë³´ë¥¼ í•¨ê»˜ ë Œë”ë§í•©ë‹ˆë‹¤. ----- #### **Phase 7: feat/ocr-capture (Optional) - Text Recognition** **Objective**: ML Kitì„ ì‚¬ìš©í•˜ì—¬ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³  ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ì— ì¶”ê°€í•©ë‹ˆë‹¤. * **Implementation**: OcrClient.ktë¥¼ êµ¬í˜„í•˜ì—¬ ì´ë¯¸ì§€ì—ì„œ í…ìŠ¤íŠ¸ë¥¼ ì¶”ì¶œí•˜ê³ , source="ocr"ë¡œ í•˜ì—¬ ingest_items í…Œì´ë¸”ì— ì €ì¥í•©ë‹ˆë‹¤. ----- #### **DoD (Definition of Done) - ê° ë‹¨ê³„ ê³µí†µ** * ìƒˆ ë¸Œëœì¹˜ì—ì„œ ì‘ì—…ì„ ì‹œì‘í•˜ê³ , ëª¨ë“  ì½”ë“œëŠ” ë¹Œë“œ ë° Gradle ë™ê¸°í™”ì— ì„±ê³µí•´ì•¼ í•©ë‹ˆë‹¤. * êµ¬í˜„ëœ ê¸°ëŠ¥ì— ëŒ€í•œ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ë˜ëŠ” ìˆ˜ë™ í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ í†µê³¼í•´ì•¼ í•©ë‹ˆë‹¤. * README.mdì— ìƒˆë¡œìš´ ê¸°ëŠ¥ì˜ ì‚¬ìš©ë²•, í•„ìš”í•œ ê¶Œí•œ, ìŠ¤í¬ë¦°ìƒ· ë“±ì„ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤. * ì‘ì—… ì™„ë£Œ í›„ main ë¸Œëœì¹˜ë¡œ Pull Request(PR)ë¥¼ ìƒì„±í•©ë‹ˆë‹¤. **ì´ ì „ì²´ ê³„íšì— ë”°ë¼, Phase 1 (feat/init-db)ë¶€í„° ê°œë°œì„ ì‹œì‘í•˜ì‹­ì‹œì˜¤.**